#!/bin/bash
set -eu
set -o pipefail

# draft-release
# Script to create a release branch and PR for a new version
#
# Usage:
#   ./release/draft-release <bump_type> [previous_version]
#   bump_type: major, minor, or patch
#   previous_version: Optional previous version for changelog (e.g., 1.2.2)
#
# Example:
#   ./scripts/release/draft-release minor
#   ./scripts/release/draft-release patch 1.2.2


# Function to display usage
usage() {
    echo "Usage: $0 <bump_type> [previous_version]"
    echo "  bump_type: major, minor, or patch"
    echo "  previous_version: Optional previous version for changelog (e.g., 1.2.2)"
    exit 1
}

# Check if required arguments are provided
if [ "$#" -lt 1 ] || [ "$#" -gt 2 ]; then
    usage
fi

BUMP_TYPE=$1
PREV_VERSION=$2

# Validate bump type
if [[ ! "$BUMP_TYPE" =~ ^(major|minor|patch)$ ]]; then
    echo "Error: bump_type must be major, minor, or patch"
    usage
fi

# Get current version from pyproject.toml
CURRENT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
if [ -z "$CURRENT_VERSION" ]; then
    echo "Error: Could not find version in pyproject.toml"
    exit 1
fi

# If no previous version provided, use the one in pyproject.toml
if [ -z "$PREV_VERSION" ]; then
    PREV_VERSION=$CURRENT_VERSION
    echo "Using current version ($CURRENT_VERSION) as previous version"
fi

# Split version into components
IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
MAJOR="${VERSION_PARTS[0]}"
MINOR="${VERSION_PARTS[1]}"
PATCH="${VERSION_PARTS[2]}"

# Generate new version based on bump type
case "$BUMP_TYPE" in
    major)
        NEW_VERSION="$((MAJOR + 1)).0.0"
        ;;
    minor)
        NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
        ;;
    patch)
        NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
        ;;
esac

echo "Current version: $CURRENT_VERSION"
echo "New version: $NEW_VERSION"
echo "Previous version from changelog: $PREV_VERSION"

# Check if we're on main branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo "Error: Must be on main branch"
    exit 1
fi

# Check if GitHub CLI is installed and authenticated
if ! command -v gh &> /dev/null; then
    echo "Error: GitHub CLI (gh) is not installed"
    exit 1
fi

if ! gh auth status &> /dev/null; then
    echo "Error: GitHub CLI is not authenticated"
    exit 1
fi

# Create new branch
BRANCH_NAME="release-v$NEW_VERSION"
echo "Creating branch: $BRANCH_NAME"

# Check if branch already exists
if git show-ref --verify --quiet refs/heads/$BRANCH_NAME; then
    echo "Error: Branch $BRANCH_NAME already exists"
    exit 1
fi

git checkout -b "$BRANCH_NAME"

# Make the update-release-documentation.sh script executable
chmod +x scripts/release/update-release-documentation.sh

# Get the absolute path of the script's directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# Call the update-release-documentation.sh script with the new version
"$SCRIPT_DIR/update-release-documentation.sh" "$NEW_VERSION" "$PREV_VERSION"

# Commit changes
git add pyproject.toml CHANGELOG.md
git commit -m "Bump version to $NEW_VERSION"

# Push branch
git push -u origin "$BRANCH_NAME"

# Create the pull request
echo "Creating pull request..."

# Construct PR body from template
PR_TEMPLATE=".github/PULL_REQUEST_TEMPLATE.md"
TEMP_PR_BODY=$(mktemp)
trap 'rm -f "$TEMP_PR_BODY"' EXIT

# Get git log since previous tag
PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
if [ -n "$PREV_TAG" ]; then
    GIT_LOG=$(git log --pretty=format:"- %s" "$PREV_TAG"..HEAD)
else
    GIT_LOG=$(git log --pretty=format:"- %s" HEAD)
fi

# Default PR body if no template
PR_BODY="## Changes\n\n- Updated version to $NEW_VERSION\n- Updated CHANGELOG.md with all changes since the previous release.\n\n## Checklist\n- [ ] Review changelog entries\n- [ ] Verify version bump\n- [ ] Test the changes\n- [ ] Approve the release\n- [ ] I've added or updated unit tests where necessary\n- [ ] I've added or updated documentation\n- [ ] I've run \`pdoc3\` to generate the documentation\n- [ ] I've manually tested the functionality in this PR\n- [ ] This pull request is ready for review"

if [ -f "$PR_TEMPLATE" ]; then
    # Create a temporary file with the template
    cp "$PR_TEMPLATE" "$TEMP_PR_BODY"

    # Add our changes to the Summary section
    sed -i '' '/^## Summary$/a\
- Updated version to '"$NEW_VERSION"'\
- Updated CHANGELOG.md with all changes since the previous release.' "$TEMP_PR_BODY"

    # Add git log to What Changed section
    echo "$GIT_LOG" > "$TEMP_PR_BODY.tmp"
    sed -i '' '/^## What Changed$/r '"$TEMP_PR_BODY.tmp" "$TEMP_PR_BODY"
    rm "$TEMP_PR_BODY.tmp"

    # Add our checklist items
    sed -i '' '/^## Checklist$/a\
- [ ] Review changelog entries\
- [ ] Verify version bump\
- [ ] Test the changes\
- [ ] Approve the release' "$TEMP_PR_BODY"

    PR_BODY=$(cat "$TEMP_PR_BODY")
fi

gh pr create \
    --title "Release v$NEW_VERSION" \
    --body "$PR_BODY" \
    --base main \
    --head "release-v$NEW_VERSION" \
    --draft

echo "Done! Review the changes and merge the pull request when ready."
